/**
 * DeLorean - Flux capacitor for accurately faking time-bound 
 * JavaScript unit testing, including timeouts, intervals, and dates
 *
 * version 0.1.2
 * 
 * http://michaelmonteleone.net/projects/delorean
 * http://github.com/mmonteleone/delorean
 *
 * Copyright (c) 2009 Michael Monteleone
 * Licensed under terms of the MIT License (README.markdown)
 */
(function(){var f=this;var B='0.1.2';var r=false;var j={};var o=0;var s=0;var x=0;var l=false;var m=false;var p={setTimeout:f.setTimeout,setInterval:f.setInterval,clearTimeout:f.clearTimeout,clearInterval:f.clearInterval,Date:f.Date};var C=function(a,c,d,g,e,k,n){var i;if(arguments.length===0){i=new p.Date();i.setMilliseconds(i.getMilliseconds()+t())}else if(arguments.length==1){i=new p.Date(arguments[0])}else{i=new p.Date(a||null,c||null,d||null,g||null,e||null,k||null,n||null)}return i};var y=function(a,c){for(var d in c){a[d]=c[d]}};var z=function(){j={};x=0;o=0;l=false;m=false;s=0};var u=function(a){return a!==null&&!isNaN(a)};var t=function(){return l?s:o};var D=function(g){if(!!g){if(!u(g)||g<0){throw("'ms' argument must be a positive number");}var e=[];var k={start:o,end:o+=g};var n=function(a,c){e.push({fn:a,at:c})};do{m=false;for(var i in j){var b=j[i];if(!b.repeats&&b.firstRunAt<=k.end){n(b,b.firstRunAt)}else{if(b.lastRunAt===null&&b.firstRunAt>k.start&&(b.lastRunAt||b.firstRunAt)<=k.end){b.lastRunAt=b.firstRunAt;n(b,b.lastRunAt)}while((b.lastRunAt||b.firstRunAt)+b.ms<=k.end){b.lastRunAt+=b.ms;n(b,b.lastRunAt)}}}e.sort(function(a,c){var d=a.at-c.at;if(d===0){d=c.fn.ms-a.fn.ms;if(d===0){d=a.fn.id-c.fn.id}}return d});var v=[];for(var h=0;h<e.length;++h){var b=e[h].fn;if(!!j[b.id]){s=e[h].at;l=true;try{b.fn.apply(f)}finally{l=false;v.push(h);if(!b.repeats){w(b.id)}if(m){break}}}}for(var h=v.length-1;h>=0;h--){e.splice(v[h],1)}}while(m)}return t()};var q=function(a,c,d){if(typeof(a)=='string'){a=new Function(a)}var g=t();var e=x++;j[e]={id:e,fn:a,ms:c,addedAt:g,firstRunAt:(g+c),lastRunAt:null,repeats:d};if(l){m=true}return e};var w=function(a){delete j[a]};var E=function(a){if(typeof(a)!=='undefined'){r=a;y(f,r?A:p)}return r};var A={setTimeout:function(a,c){if(arguments.length===0){throw("Function setTimeout requires at least 1 parameter");}else if(arguments.length===1&&u(arguments[0])){throw("useless setTimeout call (missing quotes around argument?)");}else if(arguments.length===1){return q(a,0,false)}return q(a,c,false)},setInterval:function(a,c){if(arguments.length===0){throw("Function setInterval requires at least 1 parameter");}else if(arguments.length===1&&u(arguments[0])){throw("useless setTimeout call (missing quotes around argument?)");}else if(arguments.length===1){return q(a,0,false)}return q(a,c,true)},clearTimeout:w,clearInterval:w,Date:C};f.DeLorean={reset:z,advance:D,globalApi:E,version:B};y(f.DeLorean,A);z()})();